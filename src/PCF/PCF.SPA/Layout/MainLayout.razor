@inherits LayoutComponentBase

<MudThemeProvider @ref="_mudThemeProvider" @bind-IsDarkMode="@_isDarkMode" Theme="_theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />
<MudLayout>
    @if (_isLoggedIn)
    {
        <MudAppBar>
            <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
            <MudText>My Application</MudText>
            <MudSpacer />        
            <MudButton Variant="Variant.Outlined" OnClick="Logout" Color="Color.Success">
                Deslogar
            </MudButton>        
        </MudAppBar>
    }

    @if (_isLoggedIn)
    {
        <MudDrawer @bind-Open="@_drawerOpen">
            <AppNavMenu />
        </MudDrawer>
    }

    <MudMainContent>
        @Body
    </MudMainContent>
    <MudAppBar Bottom="true" Elevation="1" Fixed="true">
        <MudSpacer />
        <MudButton Variant="Variant.Text" OnClick="ToggleMode">
            <MudIcon Color="@(_isDarkMode ? Color.Info : Color.Warning)" Icon="@Icons.Material.Outlined.LightMode" />
            <MudIcon Color="Color.Default" Icon="@(_isDarkMode ? Icons.Material.Outlined.ArrowForward : Icons.Material.Outlined.ArrowBack)" />
            <MudIcon Color="@(_isDarkMode ? Color.Warning : Color.Info)" Icon="@Icons.Material.Outlined.ModeNight" />
        </MudButton>
    </MudAppBar>
</MudLayout>

@code {
    private MudTheme _theme = new();
    private bool _isDarkMode;
    private MudThemeProvider _mudThemeProvider;

    private bool _isLoggedIn;
    bool _drawerOpen = true;

    [Inject] private AuthService AuthService { get; set; }
    [Inject] private NavigationManager Navigation { get; set; }

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _mudThemeProvider != null)
        {
            _isDarkMode = await _mudThemeProvider.GetSystemPreference();
            await CheckAuthenticationStatus();
            StateHasChanged();
            AuthService.OnAuthenticationStateChanged += HandleAuthenticationStateChanged;
        }
    }

    private async Task CheckAuthenticationStatus()
    {
        _isLoggedIn = await AuthService.IsLoggedIn();
    }

    private void HandleAuthenticationStateChanged()
    {
        InvokeAsync(async () =>
        {
            await CheckAuthenticationStatus();
            StateHasChanged(); // Atualiza a interface ao detectar mudanças
        });
    }

    private async Task Logout()
    {
        if (_isLoggedIn)
        {
            // Logout
            await AuthService.LogoutAsync();
            _isLoggedIn = false;

            // Redireciona para a tela de login
            Navigation.NavigateTo("/");
        }
    }

    public void Dispose()
    {
        // Remove a inscrição do evento ao descartar o componente
        AuthService.OnAuthenticationStateChanged -= HandleAuthenticationStateChanged;
    }

    private void ToggleMode()
    {
        _isDarkMode = !_isDarkMode;
    }
}
